<story-context id="2-1-create-property" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>Create Property</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-1-create-property.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>property owner</asA>
    <iWant>add a new rental property to my portfolio</iWant>
    <soThat>I can track expenses and income for that property</soThat>
    <tasks>
      <task id="1" acs="2.1.4, 2.1.5">
        <title>Create Property Entity and Configuration</title>
        <subtasks>
          <subtask>Verify/update Property.cs entity in Domain layer with all address fields</subtask>
          <subtask>Create PropertyConfiguration.cs in Infrastructure for EF Core mapping</subtask>
          <subtask>Add Property DbSet to AppDbContext</subtask>
          <subtask>Configure AccountId global query filter for tenant isolation</subtask>
          <subtask>Configure soft delete global query filter (DeletedAt == null)</subtask>
          <subtask>Create and apply EF Core migration</subtask>
        </subtasks>
      </task>
      <task id="2" acs="2.1.3, 2.1.4, 2.1.5">
        <title>Create Property Command and Handler</title>
        <subtasks>
          <subtask>Create CreatePropertyCommand.cs with all property fields</subtask>
          <subtask>Create CreatePropertyValidator.cs with FluentValidation rules</subtask>
          <subtask>Create CreatePropertyHandler.cs implementing IRequestHandler</subtask>
          <subtask>Handler sets AccountId from ICurrentUser service</subtask>
          <subtask>Handler sets CreatedAt and UpdatedAt timestamps</subtask>
          <subtask>Write unit tests for CreatePropertyHandler</subtask>
          <subtask>Write unit tests for CreatePropertyValidator</subtask>
        </subtasks>
      </task>
      <task id="3" acs="2.1.1, 2.1.3, 2.1.5">
        <title>Create PropertiesController with POST Endpoint</title>
        <subtasks>
          <subtask>Create PropertiesController.cs in Api layer</subtask>
          <subtask>Implement POST /api/v1/properties endpoint</subtask>
          <subtask>Add [Authorize] attribute for authentication</subtask>
          <subtask>Return 201 Created with { id } and Location header</subtask>
          <subtask>Return 400 Bad Request for validation errors</subtask>
          <subtask>Add endpoint to Swagger documentation</subtask>
          <subtask>Write integration tests for POST endpoint</subtask>
        </subtasks>
      </task>
      <task id="4" acs="2.1.1">
        <title>Create Angular Properties Module and Routing</title>
        <subtasks>
          <subtask>Create features/properties/ module structure</subtask>
          <subtask>Create properties.routes.ts with lazy loading</subtask>
          <subtask>Add routes: /properties, /properties/new</subtask>
          <subtask>Register routes in app.routes.ts</subtask>
          <subtask>Add "Properties" link to navigation sidebar</subtask>
          <subtask>Add "Add Property" button to dashboard empty state</subtask>
        </subtasks>
      </task>
      <task id="5" acs="2.1.2, 2.1.3">
        <title>Create Property Form Component</title>
        <subtasks>
          <subtask>Create PropertyFormComponent with reactive form</subtask>
          <subtask>Add form fields: name, street, city, state, zipCode</subtask>
          <subtask>Create state dropdown with US states list</subtask>
          <subtask>Implement client-side validation matching backend rules</subtask>
          <subtask>Show validation errors on blur (per UX patterns)</subtask>
          <subtask>Implement form submission with loading state</subtask>
          <subtask>Display snackbar on success</subtask>
          <subtask>Navigate to dashboard on success</subtask>
          <subtask>Write component tests with Vitest</subtask>
        </subtasks>
      </task>
      <task id="6" acs="2.1.3">
        <title>Create Property Service and API Integration</title>
        <subtasks>
          <subtask>Generate/update API client with NSwag</subtask>
          <subtask>Create PropertyService or use generated client</subtask>
          <subtask>Implement createProperty() method</subtask>
          <subtask>Handle API errors and display messages</subtask>
          <subtask>Write service tests</subtask>
        </subtasks>
      </task>
      <task id="7" acs="2.1.1, 2.1.3">
        <title>Update Dashboard for Property Navigation</title>
        <subtasks>
          <subtask>Add "Add Property" button to dashboard</subtask>
          <subtask>Display empty state when no properties exist</subtask>
          <subtask>Empty state message: "No properties yet. Add your first property to get started."</subtask>
          <subtask>Style consistent with Forest Green theme</subtask>
        </subtasks>
      </task>
      <task id="8">
        <title>Manual Testing and Documentation</title>
        <subtasks>
          <subtask>Test full create property flow end-to-end</subtask>
          <subtask>Verify multi-tenant isolation (create with different accounts)</subtask>
          <subtask>Update Postman collection with POST /api/v1/properties</subtask>
          <subtask>Document any environment-specific configurations</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-2.1.1">
      <title>User can access "Add Property" form from dashboard or navigation</title>
      <conditions>
        <condition>Dashboard shows "Add Property" button (visible even when no properties exist)</condition>
        <condition>Navigation provides access to Properties page with "Add Property" option</condition>
        <condition>Unauthenticated users are redirected to login</condition>
      </conditions>
    </criterion>
    <criterion id="AC-2.1.2">
      <title>Form displays all required fields with proper validation</title>
      <conditions>
        <condition>Name field (required) - e.g., "Oak Street Duplex"</condition>
        <condition>Street Address field (required)</condition>
        <condition>City field (required)</condition>
        <condition>State field (required, dropdown with US states)</condition>
        <condition>ZIP Code field (required, 5-digit format)</condition>
        <condition>Validation errors shown on blur and on submit</condition>
        <condition>Error messages displayed below respective fields</condition>
      </conditions>
    </criterion>
    <criterion id="AC-2.1.3">
      <title>Successful save creates property and shows confirmation</title>
      <conditions>
        <condition>POST to /api/v1/properties returns 201 with { id: "guid" }</condition>
        <condition>Snackbar displays "Property added ✓"</condition>
        <condition>User redirected to dashboard</condition>
        <condition>New property appears in property list immediately</condition>
      </conditions>
    </criterion>
    <criterion id="AC-2.1.4">
      <title>Property created with correct multi-tenant isolation</title>
      <conditions>
        <condition>Property record includes user's AccountId from JWT claims</condition>
        <condition>Other users in different accounts cannot see this property</condition>
        <condition>Property assigned a new GUID as primary key</condition>
      </conditions>
    </criterion>
    <criterion id="AC-2.1.5">
      <title>Backend validation enforces data integrity</title>
      <conditions>
        <condition>Name: required, max 255 characters</condition>
        <condition>Street: required, max 255 characters</condition>
        <condition>City: required, max 100 characters</condition>
        <condition>State: required, exactly 2 characters (US state code)</condition>
        <condition>ZIP Code: required, exactly 5 digits</condition>
        <condition>Validation errors return 400 with RFC 7807 Problem Details format</condition>
      </conditions>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Overview, APIs and Interfaces, Data Models</section>
        <snippet>POST /api/v1/properties → { id: "guid" }, CreatePropertyRequest with name, street, city, state, zipCode. Property entity with AccountId for multi-tenancy.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Backend Structure, API Contracts, Multi-Tenancy</section>
        <snippet>Clean Architecture 4-layer structure. RESTful API at /api/v1/. Account-based multi-tenancy with EF Core global query filters. CQRS with MediatR pattern.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR7-FR11 Property Management</section>
        <snippet>FR7: Users can create a new property with name and address. FR8: Users can view a list of all their properties.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 2: Property Management, Story 2.1</section>
        <snippet>Story 2.1 - Create Property. Form with Name, Street, City, State, ZIP. Save creates with AccountId. POST /api/v1/properties returns 201 with { id }.</snippet>
      </doc>
      <doc>
        <path>CLAUDE.md</path>
        <title>Development Guidelines</title>
        <section>Development Commands, Architecture</section>
        <snippet>Backend: dotnet commands from /backend. Frontend: npm commands from /frontend. EF migrations add with --project src/PropertyManager.Infrastructure.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/src/PropertyManager.Domain/Entities/Property.cs</path>
        <kind>entity</kind>
        <symbol>Property</symbol>
        <lines>1-21</lines>
        <reason>Existing Property entity - needs Street, City, State, ZipCode fields added. Currently only has Name and Address.</reason>
      </artifact>
      <artifact>
        <path>backend/src/PropertyManager.Application/Common/Interfaces/ICurrentUser.cs</path>
        <kind>interface</kind>
        <symbol>ICurrentUser</symbol>
        <lines>1-15</lines>
        <reason>Interface for accessing current user's AccountId - required for setting property ownership.</reason>
      </artifact>
      <artifact>
        <path>backend/src/PropertyManager.Infrastructure/Persistence/AppDbContext.cs</path>
        <kind>context</kind>
        <symbol>AppDbContext</symbol>
        <lines>33-85</lines>
        <reason>DbContext with Properties DbSet and tenant isolation filters already configured. Audit fields auto-populated on save.</reason>
      </artifact>
      <artifact>
        <path>backend/src/PropertyManager.Api/Controllers/AuthController.cs</path>
        <kind>controller</kind>
        <symbol>AuthController</symbol>
        <lines>12-60</lines>
        <reason>Reference for controller patterns: MediatR injection, validation, Problem Details response, 201 Created response.</reason>
      </artifact>
      <artifact>
        <path>backend/src/PropertyManager.Application/Auth/Register.cs</path>
        <kind>command</kind>
        <symbol>RegisterCommand, RegisterCommandValidator, RegisterCommandHandler</symbol>
        <lines>1-115</lines>
        <reason>Reference for CQRS pattern: Command + Validator + Handler in single file. FluentValidation rules pattern.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/app/features/auth/register/register.component.ts</path>
        <kind>component</kind>
        <symbol>RegisterComponent</symbol>
        <lines>1-142</lines>
        <reason>Reference for Angular form patterns: reactive forms, validation, signals, error handling, Material imports.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/app/core/services/auth.service.ts</path>
        <kind>service</kind>
        <symbol>AuthService</symbol>
        <reason>Reference for service patterns and HTTP client usage.</reason>
      </artifact>
    </code>
    <dependencies>
      <backend>
        <package name="Microsoft.NET.Sdk.Web" version="net10.0" />
        <package name="FluentValidation.AspNetCore" version="11.3.1" />
        <package name="Microsoft.AspNetCore.Authentication.JwtBearer" version="10.0.0" />
        <package name="Microsoft.EntityFrameworkCore.Design" version="10.0.0" />
        <package name="NSwag.AspNetCore" version="14.6.3" />
        <package name="Serilog.AspNetCore" version="10.0.0" />
        <package name="MediatR" project="PropertyManager.Application" />
      </backend>
      <frontend>
        <package name="@angular/core" version="^20.3.0" />
        <package name="@angular/material" version="^20.2.14" />
        <package name="@angular/forms" version="^20.3.0" />
        <package name="@angular/router" version="^20.3.0" />
        <package name="@ngrx/signals" version="^20.1.0" />
        <package name="rxjs" version="~7.8.0" />
        <package name="vitest" version="^3.2.4" dev="true" />
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint category="architecture">
      <rule>Follow Clean Architecture: Domain → Application → Infrastructure → Api dependency direction</rule>
      <rule>Commands/Queries in Application layer using MediatR IRequest pattern</rule>
      <rule>Validators co-located with commands using FluentValidation</rule>
      <rule>Controllers delegate to MediatR, no business logic</rule>
    </constraint>
    <constraint category="api">
      <rule>Base URL: /api/v1/</rule>
      <rule>POST returns 201 Created with { id: "guid" } and Location header</rule>
      <rule>Validation errors return 400 with RFC 7807 Problem Details format</rule>
      <rule>[Authorize] attribute required on all protected endpoints</rule>
    </constraint>
    <constraint category="data">
      <rule>All tenant data filtered by AccountId via EF Core global query filters</rule>
      <rule>GUIDs for all primary keys</rule>
      <rule>Soft delete via DeletedAt timestamp</rule>
      <rule>Audit fields (CreatedAt, UpdatedAt) auto-populated by SaveChangesAsync</rule>
    </constraint>
    <constraint category="frontend">
      <rule>Angular 20 standalone components</rule>
      <rule>Reactive forms with validation on blur pattern</rule>
      <rule>Angular Material components (mat-form-field, mat-select, mat-button)</rule>
      <rule>Signals for component state (@ngrx/signals for global state if needed)</rule>
      <rule>Forest Green theme (#66BB6A primary)</rule>
    </constraint>
    <constraint category="testing">
      <rule>Backend: xUnit for unit and integration tests</rule>
      <rule>Frontend: Vitest for component tests</rule>
      <rule>Test naming: Method_Scenario_ExpectedResult</rule>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/v1/properties</name>
      <kind>REST endpoint</kind>
      <signature>
        Request: { name: string, street: string, city: string, state: string, zipCode: string }
        Response 201: { id: "guid" }
        Response 400: { type, title, status, errors: { field: [messages] } }
      </signature>
      <path>backend/src/PropertyManager.Api/Controllers/PropertiesController.cs (to create)</path>
    </interface>
    <interface>
      <name>CreatePropertyCommand</name>
      <kind>MediatR command</kind>
      <signature>record CreatePropertyCommand(string Name, string Street, string City, string State, string ZipCode) : IRequest&lt;Guid&gt;</signature>
      <path>backend/src/PropertyManager.Application/Properties/CreateProperty.cs (to create)</path>
    </interface>
    <interface>
      <name>ICurrentUser</name>
      <kind>service interface</kind>
      <signature>Guid UserId, Guid AccountId, string Role, bool IsAuthenticated</signature>
      <path>backend/src/PropertyManager.Application/Common/Interfaces/ICurrentUser.cs</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend uses xUnit with Method_Scenario_ExpectedResult naming convention. Unit tests in PropertyManager.Application.Tests and PropertyManager.Domain.Tests. Integration tests in PropertyManager.Api.Tests test full HTTP endpoints. Frontend uses Vitest with Testing Library patterns. Tests should verify both happy path and validation error scenarios.
    </standards>
    <locations>
      <location>backend/tests/PropertyManager.Application.Tests/</location>
      <location>backend/tests/PropertyManager.Api.Tests/</location>
      <location>frontend/src/app/features/properties/**/*.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-2.1.3">CreatePropertyHandler_ValidCommand_ReturnsNewGuid</idea>
      <idea ac="AC-2.1.4">CreatePropertyHandler_SetsAccountIdFromCurrentUser</idea>
      <idea ac="AC-2.1.5">CreatePropertyValidator_MissingName_ReturnsValidationError</idea>
      <idea ac="AC-2.1.5">CreatePropertyValidator_InvalidState_ReturnsValidationError</idea>
      <idea ac="AC-2.1.5">CreatePropertyValidator_InvalidZipCode_ReturnsValidationError</idea>
      <idea ac="AC-2.1.3">PropertiesController_POST_ValidRequest_Returns201WithId</idea>
      <idea ac="AC-2.1.5">PropertiesController_POST_InvalidRequest_Returns400WithProblemDetails</idea>
      <idea ac="AC-2.1.4">PropertiesController_POST_CreatesPropertyWithCorrectAccountId</idea>
      <idea ac="AC-2.1.2">PropertyFormComponent_ShowsValidationErrorsOnBlur</idea>
      <idea ac="AC-2.1.3">PropertyFormComponent_SuccessfulSubmit_ShowsSnackbarAndNavigates</idea>
    </ideas>
  </tests>
</story-context>
