# Property Manager - Architecture

## Executive Summary

Property Manager is a web application that transforms paper-based rental property expense tracking into organized, tax-ready Schedule E reports. This architecture document defines the technical decisions and patterns that ensure consistent implementation across all development - whether by AI agents or human developers.

**Core Stack:**
- **Frontend:** Angular 21 + @ngrx/signals + Angular Material
- **Backend:** .NET 10 + ASP.NET Core + Clean Architecture + CQRS/MediatR
- **Database:** PostgreSQL + EF Core 10
- **Hosting:** Render (portable to AWS/GCP/Azure)

## Decision Summary

| # | Category | Decision | Rationale |
|---|----------|----------|-----------|
| 1 | Project Structure | Monorepo, 4-layer Clean Architecture | Clear separation, single PR for full features |
| 2 | Authentication | ASP.NET Core Identity + JWT + RBAC | Full control, multi-user ready, Owner/Contributor roles |
| 3 | API Design | RESTful, `/api/v1/`, GUIDs, plural resources | Industry standard, NSwag generates TypeScript client |
| 4 | Database | Account-based multi-tenancy, soft deletes, audit fields | Tenant isolation, data recovery, traceability |
| 5 | Receipt Storage | AWS S3, presigned URLs, direct upload | Scalable, secure, bypasses server for uploads |
| 6 | CI/CD | Docker-based, PR triggers tests, merge deploys | Local = deployed parity, automated migrations |
| 7 | Real-time | SignalR | Dual-device receipt sync, built into ASP.NET |
| 8 | Error Handling | Global middleware, RFC 7807 Problem Details | Consistent errors, traceable |
| 9 | Logging | Serilog, structured JSON, console sink | Cloud-agnostic, searchable, correlated by traceId |
| 10 | Testing | xUnit + Vitest + Playwright + Postman + smoke tests | Automated + manual verification per story |
| 11 | Naming | PascalCase (.NET), kebab-case (Angular files), camelCase (JSON) | Language-idiomatic, predictable |
| 12 | Code Organization | Feature-based in Application layer and Angular | One obvious home for every file |
| 13 | API Responses | `{ items, totalCount }` for lists, Problem Details for errors | Predictable, typed |

## Project Structure

### Repository Layout

```
property-manager/
├── backend/
│   ├── src/
│   │   ├── PropertyManager.Domain/
│   │   ├── PropertyManager.Application/
│   │   ├── PropertyManager.Infrastructure/
│   │   └── PropertyManager.Api/
│   ├── tests/
│   │   ├── PropertyManager.Domain.Tests/
│   │   ├── PropertyManager.Application.Tests/
│   │   └── PropertyManager.Api.Tests/
│   ├── Dockerfile
│   └── PropertyManager.sln
├── frontend/
│   ├── src/
│   │   ├── app/
│   │   │   ├── core/
│   │   │   ├── shared/
│   │   │   └── features/
│   │   ├── styles/
│   │   └── assets/
│   ├── e2e/
│   ├── Dockerfile
│   └── angular.json
├── postman/
│   ├── PropertyManager.postman_collection.json
│   └── environments/
├── docker-compose.yml
├── .github/workflows/ (or .gitlab-ci.yml)
└── README.md
```

### Backend Structure (Clean Architecture)

```
PropertyManager.Domain/
├── Entities/
│   ├── Account.cs
│   ├── User.cs
│   ├── Property.cs
│   ├── Expense.cs
│   ├── Income.cs
│   ├── Receipt.cs
│   └── ExpenseCategory.cs
├── ValueObjects/
│   └── Money.cs
├── Exceptions/
│   ├── NotFoundException.cs
│   ├── ValidationException.cs
│   └── BusinessRuleException.cs
└── Interfaces/
    └── IRepository.cs

PropertyManager.Application/
├── Common/
│   ├── Behaviors/
│   │   ├── ValidationBehavior.cs
│   │   └── LoggingBehavior.cs
│   └── Interfaces/
│       ├── ICurrentUser.cs
│       └── IStorageService.cs
├── Properties/
│   ├── CreateProperty.cs
│   ├── GetProperty.cs
│   ├── GetAllProperties.cs
│   ├── UpdateProperty.cs
│   └── DeleteProperty.cs
├── Expenses/
│   ├── CreateExpense.cs
│   ├── GetExpensesByProperty.cs
│   └── ...
├── Receipts/
│   ├── UploadReceipt.cs
│   ├── GetUnprocessedReceipts.cs
│   ├── LinkReceiptToExpense.cs
│   └── ...
├── Income/
│   └── ...
└── Reports/
    ├── GenerateScheduleEReport.cs
    └── ...

PropertyManager.Infrastructure/
├── Persistence/
│   ├── AppDbContext.cs
│   ├── Configurations/
│   ├── Migrations/
│   └── Repositories/
├── Storage/
│   └── S3StorageService.cs
├── Identity/
│   └── CurrentUserService.cs
└── DependencyInjection.cs

PropertyManager.Api/
├── Controllers/
│   ├── AuthController.cs
│   ├── PropertiesController.cs
│   ├── ExpensesController.cs
│   ├── ReceiptsController.cs
│   ├── IncomeController.cs
│   └── ReportsController.cs
├── Hubs/
│   └── ReceiptHub.cs
├── Middleware/
│   └── ExceptionHandlingMiddleware.cs
└── Program.cs
```

### Frontend Structure (Feature-Based)

```
src/app/
├── core/
│   ├── auth/
│   │   ├── auth.service.ts
│   │   ├── auth.guard.ts
│   │   └── auth.interceptor.ts
│   ├── api/
│   │   └── api.service.ts          # Generated by NSwag
│   └── signalr/
│       └── signalr.service.ts
├── shared/
│   ├── components/
│   │   ├── stats-bar/
│   │   ├── confirm-dialog/
│   │   └── ...
│   ├── pipes/
│   └── directives/
├── features/
│   ├── dashboard/
│   │   ├── dashboard.component.ts
│   │   ├── dashboard.routes.ts
│   │   └── components/
│   │       └── property-row/
│   ├── properties/
│   │   ├── property-detail.component.ts
│   │   ├── properties.routes.ts
│   │   └── stores/
│   │       └── property.store.ts
│   ├── expenses/
│   │   ├── expense-workspace.component.ts
│   │   ├── expenses.routes.ts
│   │   ├── components/
│   │   │   └── expense-row/
│   │   └── stores/
│   │       └── expense.store.ts
│   ├── receipts/
│   ├── income/
│   └── reports/
├── app.component.ts
├── app.routes.ts
└── app.config.ts
```

## Technology Stack Details

### Core Technologies

| Layer | Technology | Version |
|-------|------------|---------|
| Frontend Framework | Angular | 21 |
| State Management | @ngrx/signals | Latest |
| UI Components | Angular Material | 21.x |
| Backend Runtime | .NET | 10 (LTS) |
| Web Framework | ASP.NET Core | 10 |
| ORM | Entity Framework Core | 10 |
| Database | PostgreSQL | 16 |
| Real-time | SignalR | (included in ASP.NET Core) |
| Object Storage | AWS S3 | - |
| Hosting | Render | - |

### Development Tools

| Tool | Purpose |
|------|---------|
| NSwag | Generate TypeScript API client from .NET controllers |
| Docker | Local/production parity |
| Vitest | Angular unit/component tests |
| xUnit | .NET unit/integration tests |
| Playwright | E2E tests |
| Postman | API manual testing |
| Serilog | Structured logging |
| FluentValidation | Request validation |
| MediatR | CQRS command/query handling |

## Data Architecture

### Entity Relationship

```
Account (tenant boundary)
├── Users (1:many)
│   └── Role: Owner | Contributor
├── Properties (1:many)
│   ├── Expenses (1:many)
│   │   └── Receipt (1:1 optional)
│   └── Income (1:many)
└── Receipts (1:many, can be unassigned)

ExpenseCategories (global, no AccountId)
```

### Core Tables

```sql
-- Accounts (tenant)
Accounts (
    Id UUID PRIMARY KEY,
    Name VARCHAR(255) NOT NULL,
    CreatedAt TIMESTAMP NOT NULL
)

-- Users (Identity + Account link)
Users (
    Id UUID PRIMARY KEY,
    AccountId UUID NOT NULL REFERENCES Accounts(Id),
    Email VARCHAR(255) NOT NULL UNIQUE,
    PasswordHash TEXT NOT NULL,
    Role VARCHAR(50) NOT NULL,  -- 'Owner' | 'Contributor'
    CreatedAt TIMESTAMP NOT NULL,
    UpdatedAt TIMESTAMP NOT NULL
)

-- Properties
Properties (
    Id UUID PRIMARY KEY,
    AccountId UUID NOT NULL REFERENCES Accounts(Id),
    Name VARCHAR(255) NOT NULL,
    Address TEXT,
    CreatedAt TIMESTAMP NOT NULL,
    UpdatedAt TIMESTAMP NOT NULL,
    DeletedAt TIMESTAMP NULL
)

-- Expenses
Expenses (
    Id UUID PRIMARY KEY,
    AccountId UUID NOT NULL REFERENCES Accounts(Id),
    PropertyId UUID NOT NULL REFERENCES Properties(Id),
    CategoryId UUID NOT NULL REFERENCES ExpenseCategories(Id),
    Amount DECIMAL(10,2) NOT NULL,
    Date DATE NOT NULL,
    Description TEXT,
    ReceiptId UUID NULL REFERENCES Receipts(Id),
    CreatedByUserId UUID NOT NULL REFERENCES Users(Id),
    CreatedAt TIMESTAMP NOT NULL,
    UpdatedAt TIMESTAMP NOT NULL,
    DeletedAt TIMESTAMP NULL
)

-- Receipts
Receipts (
    Id UUID PRIMARY KEY,
    AccountId UUID NOT NULL REFERENCES Accounts(Id),
    PropertyId UUID NULL REFERENCES Properties(Id),
    StorageKey VARCHAR(500) NOT NULL,  -- S3 key
    OriginalFileName VARCHAR(255),
    ContentType VARCHAR(100),
    FileSizeBytes BIGINT,
    ExpenseId UUID NULL,  -- linked after processing
    CreatedByUserId UUID NOT NULL REFERENCES Users(Id),
    CreatedAt TIMESTAMP NOT NULL,
    ProcessedAt TIMESTAMP NULL,
    DeletedAt TIMESTAMP NULL
)

-- Income
Income (
    Id UUID PRIMARY KEY,
    AccountId UUID NOT NULL REFERENCES Accounts(Id),
    PropertyId UUID NOT NULL REFERENCES Properties(Id),
    Amount DECIMAL(10,2) NOT NULL,
    Date DATE NOT NULL,
    Source VARCHAR(255),
    Description TEXT,
    CreatedByUserId UUID NOT NULL REFERENCES Users(Id),
    CreatedAt TIMESTAMP NOT NULL,
    UpdatedAt TIMESTAMP NOT NULL,
    DeletedAt TIMESTAMP NULL
)

-- ExpenseCategories (global seed data)
ExpenseCategories (
    Id UUID PRIMARY KEY,
    Name VARCHAR(100) NOT NULL,
    ScheduleELine VARCHAR(50),
    SortOrder INT NOT NULL
)
```

### Multi-Tenancy

- All tenant data filtered by `AccountId`
- EF Core global query filters enforce isolation
- JWT claims include `accountId` for current user
- Future option: separate database per tenant for enhanced privacy

## API Contracts

### Base URL

```
/api/v1/
```

### Authentication Endpoints

```
POST   /api/v1/auth/register     Register new account + owner user
POST   /api/v1/auth/login        Returns JWT
POST   /api/v1/auth/refresh      Refresh token
POST   /api/v1/auth/forgot       Send password reset email
POST   /api/v1/auth/reset        Reset password with token
POST   /api/v1/auth/invite       Invite user to account (Owner only)
```

### Resource Endpoints

```
# Properties
GET    /api/v1/properties                    List all properties
POST   /api/v1/properties                    Create property
GET    /api/v1/properties/{id}               Get property
PUT    /api/v1/properties/{id}               Update property
DELETE /api/v1/properties/{id}               Delete property (soft)
GET    /api/v1/properties/{id}/expenses      Get expenses for property
GET    /api/v1/properties/{id}/income        Get income for property

# Expenses
GET    /api/v1/expenses                      List all expenses (filterable)
POST   /api/v1/expenses                      Create expense
GET    /api/v1/expenses/{id}                 Get expense
PUT    /api/v1/expenses/{id}                 Update expense
DELETE /api/v1/expenses/{id}                 Delete expense (soft)

# Receipts
GET    /api/v1/receipts                      List receipts
GET    /api/v1/receipts/unprocessed          List unprocessed receipts
POST   /api/v1/receipts/upload-url           Get presigned S3 upload URL
POST   /api/v1/receipts                      Confirm upload, create record
GET    /api/v1/receipts/{id}                 Get receipt (includes presigned view URL)
POST   /api/v1/receipts/{id}/link            Link receipt to expense
DELETE /api/v1/receipts/{id}                 Delete receipt

# Income
GET    /api/v1/income                        List income entries
POST   /api/v1/income                        Create income entry
PUT    /api/v1/income/{id}                   Update income entry
DELETE /api/v1/income/{id}                   Delete income entry

# Reports
POST   /api/v1/reports/schedule-e            Generate Schedule E PDF(s)
GET    /api/v1/reports                       List generated reports
GET    /api/v1/reports/{id}                  Download report

# Categories
GET    /api/v1/expense-categories            List expense categories
```

### Response Formats

**Single Resource (200 OK):**
```json
{
  "id": "abc-123",
  "name": "123 Oak Street",
  "address": "Austin, TX 78701",
  "createdAt": "2025-01-15T10:30:00Z"
}
```

**Collection (200 OK):**
```json
{
  "items": [...],
  "totalCount": 14
}
```

**Paginated Collection (200 OK):**
```json
{
  "items": [...],
  "totalCount": 156,
  "page": 2,
  "pageSize": 20,
  "totalPages": 8
}
```

**Create (201 Created):**
```json
{
  "id": "xyz-789"
}
```
+ `Location` header: `/api/v1/expenses/xyz-789`

**Update/Delete (204 No Content):** No body

**Validation Error (400 Bad Request):**
```json
{
  "type": "https://propertymanager.app/errors/validation",
  "title": "Validation failed",
  "status": 400,
  "errors": {
    "amount": ["Amount must be greater than 0"],
    "propertyId": ["Property is required"]
  },
  "traceId": "00-abc123..."
}
```

**Not Found (404):**
```json
{
  "type": "https://propertymanager.app/errors/not-found",
  "title": "Resource not found",
  "status": 404,
  "detail": "Expense 'xyz-789' does not exist",
  "traceId": "00-abc123..."
}
```

## Security Architecture

### Authentication Flow

1. User registers/logs in → receives JWT (stored in HttpOnly cookie)
2. JWT contains: `userId`, `accountId`, `role`, `exp`
3. API validates JWT on every request
4. Role checked via `[Authorize(Roles = "Owner")]` where needed

### Authorization (RBAC)

| Role | Capabilities |
|------|--------------|
| Owner | Full access: CRUD all resources, invite users, generate reports |
| Contributor | Capture receipts, view properties (cannot create expenses, run reports) |

### Data Protection

- HTTPS everywhere (TLS 1.2+)
- Passwords hashed with ASP.NET Core Identity (PBKDF2)
- JWT tokens with appropriate expiration
- S3 bucket private, presigned URLs for access (15 min expiry)
- S3 objects encrypted at rest
- Database credentials in environment variables
- CORS restricted to application domain
- Input validation on all endpoints (FluentValidation)

## Real-Time Architecture

### SignalR Hub

**Purpose:** Push receipt notifications for dual-device workflow

**Hub:** `ReceiptHub`

**Groups:** Account-based (all users in same account receive notifications)

**Events:**
| Event | Payload | When |
|-------|---------|------|
| `ReceiptAdded` | `{ receiptId, thumbnail, propertyId }` | New receipt uploaded |
| `ReceiptLinked` | `{ receiptId, expenseId }` | Receipt linked to expense |

**Flow:**
```
Phone uploads receipt
    → API saves to S3 + database
    → API broadcasts via SignalR to account group
    → Desktop receives notification
    → Desktop refreshes receipt queue
```

## Implementation Patterns

### CQRS Pattern

**Commands (write operations):**
```csharp
// Application/Expenses/CreateExpense.cs
public record CreateExpenseCommand(
    Guid PropertyId,
    decimal Amount,
    DateOnly Date,
    Guid CategoryId,
    string? Description,
    Guid? ReceiptId
) : IRequest<Guid>;

public class CreateExpenseHandler : IRequestHandler<CreateExpenseCommand, Guid>
{
    public async Task<Guid> Handle(CreateExpenseCommand request, CancellationToken ct)
    {
        // Validation via FluentValidation pipeline behavior
        // Create entity
        // Save via repository
        // Return ID
    }
}
```

**Queries (read operations):**
```csharp
// Application/Expenses/GetExpensesByProperty.cs
public record GetExpensesByPropertyQuery(Guid PropertyId) : IRequest<List<ExpenseDto>>;
```

### Error Handling Pattern

```csharp
// Global exception handler middleware
app.UseExceptionHandler(handler => {
    handler.Run(async context => {
        var exception = context.Features.Get<IExceptionHandlerFeature>()?.Error;
        context.Response.StatusCode = exception switch {
            NotFoundException => 404,
            ValidationException => 400,
            UnauthorizedException => 401,
            ForbiddenException => 403,
            _ => 500
        };
        await context.Response.WriteAsJsonAsync(new ProblemDetails {
            Type = $"https://propertymanager.app/errors/{exception.GetType().Name}",
            Title = exception.Message,
            Status = context.Response.StatusCode,
            Extensions = { ["traceId"] = Activity.Current?.Id }
        });
    });
});
```

### Logging Pattern

```csharp
// Structured logging with Serilog
Log.Information("Expense created: {ExpenseId} for property {PropertyId}",
    expense.Id, expense.PropertyId);

// All logs include traceId automatically via UseSerilogRequestLogging()
```

**Log Output (JSON):**
```json
{
  "timestamp": "2025-01-15T10:30:00Z",
  "level": "Information",
  "message": "Expense created",
  "properties": {
    "expenseId": "abc-123",
    "propertyId": "def-456",
    "traceId": "00-xyz...",
    "accountId": "ghi-789"
  }
}
```

## Naming Conventions

### Backend (.NET)

| Element | Convention | Example |
|---------|------------|---------|
| Projects | `PropertyManager.{Layer}` | `PropertyManager.Domain` |
| Classes | PascalCase | `CreateExpenseHandler` |
| Interfaces | `I` prefix | `IExpenseRepository` |
| Methods | PascalCase, verb-first | `GetByIdAsync` |
| Private fields | `_camelCase` | `_logger` |
| Async methods | `Async` suffix | `HandleAsync` |
| Commands | Verb + Noun | `CreateExpense` |
| Queries | Get + What | `GetExpenseById` |
| Handlers | Command/Query + `Handler` | `CreateExpenseHandler` |

### Database

| Element | Convention | Example |
|---------|------------|---------|
| Tables | PascalCase plural | `Expenses` |
| Columns | PascalCase | `PropertyId` |
| Primary keys | `Id` | `Id` |
| Foreign keys | `{Entity}Id` | `PropertyId` |
| Indexes | `IX_{Table}_{Columns}` | `IX_Expenses_AccountId` |

### Frontend (Angular)

| Element | Convention | Example |
|---------|------------|---------|
| Files | kebab-case | `expense-row.component.ts` |
| Components | PascalCase class | `ExpenseRowComponent` |
| Services | `.service.ts` | `expense.service.ts` |
| Stores | `.store.ts` | `expense.store.ts` |
| Signals | noun, no prefix | `expenses`, `isLoading` |

### API

| Element | Convention | Example |
|---------|------------|---------|
| URLs | kebab-case, plural | `/expense-categories` |
| JSON properties | camelCase | `propertyId` |
| Query params | camelCase | `?pageSize=20` |

## Deployment Architecture

### Local Development

```yaml
# docker-compose.yml
services:
  api:
    build: ./backend
    environment:
      - ConnectionStrings__Default=Host=db;Database=propertymanager;...
      - AWS__BucketName=property-manager-receipts-dev
    ports:
      - "5000:8080"
    depends_on:
      - db

  web:
    build: ./frontend
    ports:
      - "4200:80"

  db:
    image: postgres:16
    environment:
      - POSTGRES_DB=propertymanager
      - POSTGRES_PASSWORD=localdev
    volumes:
      - pgdata:/var/lib/postgresql/data
```

### CI/CD Pipeline

```yaml
# Triggered on PR
pr-checks:
  - dotnet build
  - dotnet test
  - npm run build
  - npm run test
  - docker build (verify)

# Triggered on merge to main
deploy-production:
  - all pr-checks
  - docker push to registry
  - deploy to Render
  - EF migrations run on startup
```

### Environment Strategy

| Branch | Environment | Resources |
|--------|-------------|-----------|
| `main` | Production | Render web service + PostgreSQL |
| `staging` | Staging | Separate Render instance (when needed) |
| `dev` | Development | Separate Render instance (when needed) |

Same pipeline, same Docker image, different environment variables.

### Database Migrations

```csharp
// Automatic on production startup
if (app.Environment.IsProduction())
{
    using var scope = app.Services.CreateScope();
    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
    db.Database.Migrate();
}
```

Same migrations run locally (`dotnet ef database update`) and in production.

## Testing Strategy

### Test Pyramid

| Layer | Framework | What |
|-------|-----------|------|
| Unit | xUnit | Domain entities, handlers, validators |
| Integration | xUnit + Testcontainers | API endpoints with real PostgreSQL |
| Component | Vitest | Angular components, services |
| E2E | Playwright | Critical user flows |
| Manual | Postman + checklists | API verification, smoke tests |

### Test Naming

```csharp
// Method_Scenario_ExpectedResult
public async Task Handle_ValidExpense_CreatesAndReturnsId() { }
public async Task Handle_NegativeAmount_ThrowsValidationException() { }
```

### Story Definition of Done

Every PR must include:

| Deliverable | Description |
|-------------|-------------|
| Code | Implementation complete |
| Unit tests | Handler/service tests passing |
| Postman requests | New endpoints added to collection |
| Smoke test checklist | In PR description, all boxes checked |
| DB verification | Expected state documented |
| Store verification | Expected signal state changes documented |

### Smoke Test Checklist Template

```markdown
## Manual Smoke Test: [Feature Name]

### API Verification
- [ ] Endpoint returns expected status
- [ ] Response matches schema

### Database Verification
- [ ] Expected rows created/updated
- [ ] Foreign keys correct
- [ ] Audit fields populated

### Frontend Verification
- [ ] State updates in DevTools
- [ ] UI reflects changes
- [ ] Feedback shown (snackbar, etc.)

### SignalR Verification (if applicable)
- [ ] Real-time notification received
```

## Development Environment

### Prerequisites

- .NET 10 SDK
- Node.js 22 LTS
- Docker Desktop
- PostgreSQL client (psql, pgAdmin, or DataGrip)
- VS Code or JetBrains Rider
- Angular CLI (`npm install -g @angular/cli`)

### Setup Commands

```bash
# Clone repository
git clone <repo-url>
cd property-manager

# Start infrastructure
docker compose up -d db

# Backend
cd backend
dotnet restore
dotnet ef database update
dotnet run --project src/PropertyManager.Api

# Frontend (new terminal)
cd frontend
npm install
ng serve

# Access
# API: http://localhost:5000
# Web: http://localhost:4200
# Swagger: http://localhost:5000/swagger
```

### Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `ConnectionStrings__Default` | PostgreSQL connection | `Host=localhost;Database=propertymanager;...` |
| `Jwt__Secret` | JWT signing key | `<256-bit-secret>` |
| `Jwt__ExpiryMinutes` | Token lifetime | `60` |
| `AWS__AccessKeyId` | S3 access key | `AKIA...` |
| `AWS__SecretAccessKey` | S3 secret | `...` |
| `AWS__BucketName` | S3 bucket | `property-manager-receipts` |
| `AWS__Region` | S3 region | `us-east-1` |

## Architecture Decision Records

### ADR-001: Monorepo over Polyrepo

**Decision:** Single repository with `backend/` and `frontend/` folders

**Rationale:** Single developer, single PR for full features, simpler CI/CD

**Trade-offs:** Larger repo over time, but acceptable for this scale

---

### ADR-002: Account-Based Multi-Tenancy

**Decision:** Shared database with `AccountId` filtering via EF Core global query filters

**Rationale:** Simple, cost-effective, adequate isolation for current scale

**Future:** Can migrate to database-per-tenant if customers demand enhanced privacy

---

### ADR-003: SignalR over Polling

**Decision:** SignalR for real-time receipt sync

**Rationale:** Built into ASP.NET Core, two-way communication, no external dependency

**Trade-offs:** Slightly more complexity than polling, but better UX

---

### ADR-004: S3 Direct Upload

**Decision:** Client uploads directly to S3 via presigned URLs

**Rationale:** Server doesn't handle file bytes, faster uploads, better scalability

**Trade-offs:** Slightly more complex client flow, but worth it

---

### ADR-005: .NET 10 + EF Core 10 (LTS)

**Decision:** Use latest LTS versions

**Rationale:** 3-year support window (until Nov 2028), native JSON, improved LINQ

**Trade-offs:** None - LTS is the correct choice for new projects

---

### ADR-006: Angular 21 + Vitest

**Decision:** Use Angular 21 with Vitest as test runner

**Rationale:** Vitest is now Angular's official default, faster than Jest/Karma

**Trade-offs:** Migration docs available if needed

---

### ADR-007: Manual Verification Layer

**Decision:** Require Postman collection + smoke test checklist per story

**Rationale:** AI-assisted development requires human verification. "Trust but verify."

**Trade-offs:** More deliverables per PR, but catches issues before merge

---

## FR Category to Architecture Mapping

| PRD Category | Backend Module | Frontend Feature | Database Tables |
|--------------|----------------|------------------|-----------------|
| User Account & Access (FR1-6) | Auth, Identity | core/auth | Users, Accounts |
| Property Management (FR7-11) | Properties | features/properties | Properties |
| Expense Management (FR12-22) | Expenses | features/expenses | Expenses, ExpenseCategories |
| Income Management (FR23-29) | Income | features/income | Income |
| Receipt Management (FR30-37) | Receipts | features/receipts | Receipts |
| Dashboard & Views (FR38-48) | Properties, Expenses, Income | features/dashboard | (queries across tables) |
| Tax Reporting (FR49-57) | Reports | features/reports | (queries + PDF generation) |

---

_Generated by BMAD Architecture Workflow_
_Date: 2025-11-29_
_For: Dave_
