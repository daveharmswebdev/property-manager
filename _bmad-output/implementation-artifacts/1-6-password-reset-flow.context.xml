<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context Document
  Generated: 2025-11-30
  Story: 1.6 - Password Reset Flow
  Epic: 1 - Foundation
-->
<story-context>
  <meta>
    <story-id>1.6</story-id>
    <story-key>1-6-password-reset-flow</story-key>
    <title>Password Reset Flow</title>
    <epic-id>1</epic-id>
    <epic-name>Foundation</epic-name>
    <generated-date>2025-11-30</generated-date>
  </meta>

  <story-summary>
    <description>
      Implement password reset functionality allowing users to securely reset their password
      via email. This includes "forgot password" request, email with reset link, reset form,
      and server-side password update with session invalidation.
    </description>
    <acceptance-criteria>
      <criterion id="AC6.1">POST `/api/v1/auth/forgot-password` sends reset email (always returns 204 to prevent email enumeration)</criterion>
      <criterion id="AC6.2">Reset token valid for 1 hour</criterion>
      <criterion id="AC6.3">POST `/api/v1/auth/reset-password` updates password on valid token</criterion>
      <criterion id="AC6.4">All existing sessions invalidated after password reset</criterion>
      <criterion id="AC6.5">Expired/used reset token returns appropriate error</criterion>
    </acceptance-criteria>
    <functional-requirements>
      <requirement id="FR5">Password reset via email link</requirement>
    </functional-requirements>
  </story-summary>

  <technical-context>
    <architecture-pattern>Clean Architecture with CQRS/MediatR</architecture-pattern>
    <backend-framework>.NET 10, ASP.NET Core</backend-framework>
    <frontend-framework>Angular 20+ with Signals</frontend-framework>
    <database>PostgreSQL with EF Core</database>
    <key-principles>
      <principle>JWT stored in HttpOnly cookie for XSS protection</principle>
      <principle>Stateless API design for horizontal scaling</principle>
      <principle>All validation via FluentValidation</principle>
      <principle>CQRS pattern via MediatR for commands/queries</principle>
    </key-principles>
  </technical-context>

  <relevant-documentation>
    <document type="tech-spec" path="docs/sprint-artifacts/tech-spec-epic-1.md">
      <key-sections>
        <section name="Password Reset Flow">
          Detailed sequence diagram showing User -> Frontend -> API -> Email flow.
          Key points:
          - POST /forgot-password generates reset token
          - Email sent with reset link
          - User clicks link, enters new password
          - POST /reset-password validates token, updates password
          - All existing refresh tokens invalidated
          - Redirect to login
        </section>
        <section name="APIs and Interfaces">
          | Method | Endpoint | Request | Response | Description |
          | POST | `/api/v1/auth/forgot-password` | `{ email }` | 204 No Content | Send reset email |
          | POST | `/api/v1/auth/reset-password` | `{ token, newPassword }` | 204 No Content | Reset password |
        </section>
        <section name="Security">
          - Password requirements: 8+ chars, uppercase, lowercase, number, special char
          - JWT with 60-minute access token, 7-day refresh token
          - All endpoints require authentication except auth routes
        </section>
      </key-sections>
    </document>
    <document type="architecture" path="docs/architecture.md">
      <key-constraints>
        <constraint>Email service abstracted via IEmailService interface</constraint>
        <constraint>Identity operations via IIdentityService interface</constraint>
        <constraint>Token operations via IJwtService interface</constraint>
        <constraint>RFC 7807 Problem Details for error responses</constraint>
      </key-constraints>
    </document>
    <document type="ux-design" path="docs/ux-design-specification.md">
      <relevant-screens>
        <screen name="Forgot Password">Simple form with email input and submit button</screen>
        <screen name="Reset Password">Form with new password, confirm password fields</screen>
        <screen name="Confirmation">Success message with link to login</screen>
      </relevant-screens>
    </document>
  </relevant-documentation>

  <existing-code-context>
    <interface name="IIdentityService" path="backend/src/PropertyManager.Application/Common/Interfaces/IIdentityService.cs">
      <description>Identity operations - user creation, email verification, credential validation</description>
      <existing-methods>
        <method>CreateUserAsync</method>
        <method>EmailExistsAsync</method>
        <method>GenerateEmailVerificationTokenAsync</method>
        <method>VerifyEmailAsync</method>
        <method>ValidateCredentialsAsync</method>
      </existing-methods>
      <methods-to-add>
        <method name="GeneratePasswordResetTokenAsync">Generate secure token for password reset, store with 1-hour expiry</method>
        <method name="ResetPasswordAsync">Validate token, update password hash, mark token as used</method>
        <method name="GetUserIdByEmailAsync">Find user by email (needed for token generation)</method>
      </methods-to-add>
    </interface>

    <interface name="IEmailService" path="backend/src/PropertyManager.Application/Common/Interfaces/IEmailService.cs">
      <description>Email operations - verification emails</description>
      <existing-methods>
        <method>SendVerificationEmailAsync(email, token)</method>
      </existing-methods>
      <methods-to-add>
        <method name="SendPasswordResetEmailAsync">Send email with reset link containing token</method>
      </methods-to-add>
    </interface>

    <interface name="IJwtService" path="backend/src/PropertyManager.Application/Common/Interfaces/IJwtService.cs">
      <description>JWT token generation, validation, and revocation</description>
      <existing-methods>
        <method>GenerateAccessTokenAsync</method>
        <method>GenerateRefreshTokenAsync</method>
        <method>ValidateRefreshTokenAsync</method>
        <method>RevokeRefreshTokenAsync</method>
        <method name="RevokeAllUserRefreshTokensAsync">ALREADY EXISTS - Use for AC6.4 session invalidation</method>
      </existing-methods>
    </interface>

    <controller name="AuthController" path="backend/src/PropertyManager.Api/Controllers/AuthController.cs">
      <description>Authentication endpoints - register, verify-email, login, refresh, logout</description>
      <existing-endpoints>
        <endpoint>POST /api/v1/auth/register</endpoint>
        <endpoint>POST /api/v1/auth/verify-email</endpoint>
        <endpoint>POST /api/v1/auth/login</endpoint>
        <endpoint>POST /api/v1/auth/refresh</endpoint>
        <endpoint>POST /api/v1/auth/logout</endpoint>
      </existing-endpoints>
      <endpoints-to-add>
        <endpoint method="POST" path="/api/v1/auth/forgot-password">
          Request: { email: string }
          Response: 204 No Content (always, to prevent email enumeration)
          Logic: If email exists, generate token and send email
        </endpoint>
        <endpoint method="POST" path="/api/v1/auth/reset-password">
          Request: { token: string, newPassword: string }
          Response: 204 No Content on success, 400 on invalid/expired token
          Logic: Validate token, update password, revoke all refresh tokens
        </endpoint>
      </endpoints-to-add>
    </controller>

    <service name="AuthService (Frontend)" path="frontend/src/app/core/services/auth.service.ts">
      <description>Angular service for authentication - signals-based state management</description>
      <existing-methods>
        <method>register()</method>
        <method>verifyEmail()</method>
        <method>login()</method>
        <method>refreshToken()</method>
        <method>logout()</method>
      </existing-methods>
      <methods-to-add>
        <method name="forgotPassword(email: string)">POST to forgot-password endpoint</method>
        <method name="resetPassword(token: string, newPassword: string)">POST to reset-password endpoint</method>
      </methods-to-add>
    </service>

    <command-pattern>
      <description>Follow existing MediatR command pattern from Register.cs and Logout.cs</description>
      <files-to-create>
        <file path="backend/src/PropertyManager.Application/Auth/ForgotPassword.cs">
          <contents>
            - ForgotPasswordCommand(Email)
            - ForgotPasswordResult(Success - always true)
            - ForgotPasswordCommandValidator (email format validation)
            - ForgotPasswordCommandHandler (check email exists, generate token, send email)
          </contents>
        </file>
        <file path="backend/src/PropertyManager.Application/Auth/ResetPassword.cs">
          <contents>
            - ResetPasswordCommand(Token, NewPassword)
            - ResetPasswordResult(Success, ErrorMessage?)
            - ResetPasswordCommandValidator (password strength validation - reuse from Register)
            - ResetPasswordCommandHandler (validate token, update password, revoke all tokens)
          </contents>
        </file>
      </files-to-create>
    </command-pattern>

    <entity name="RefreshToken" path="backend/src/PropertyManager.Domain/Entities/RefreshToken.cs">
      <description>Refresh token storage for session management</description>
      <note>RevokeAllUserRefreshTokensAsync in IJwtService will set RevokedAt on all tokens for a user</note>
    </entity>
  </existing-code-context>

  <implementation-notes>
    <note priority="high">
      Token Storage Strategy: Password reset tokens should be stored similarly to email verification tokens.
      Check IdentityService implementation for GenerateEmailVerificationTokenAsync pattern - likely using
      ASP.NET Core Identity's UserManager.GeneratePasswordResetTokenAsync().
    </note>
    <note priority="high">
      Security: Always return 204 from forgot-password regardless of whether email exists (AC6.1).
      This prevents attackers from enumerating valid email addresses.
    </note>
    <note priority="high">
      Session Invalidation (AC6.4): Call IJwtService.RevokeAllUserRefreshTokensAsync() after successful
      password reset. This ensures all existing sessions (devices) are logged out.
    </note>
    <note priority="medium">
      Token Format: Consider using the same Base64-encoded format as email verification tokens:
      Base64(UserId:Token) for easy extraction.
    </note>
    <note priority="medium">
      Frontend Routes: Need to add /forgot-password and /reset-password routes.
      Reset password page should extract token from query parameter (?token=xxx).
    </note>
    <note priority="low">
      Email Template: Keep it simple for MVP - plain HTML with reset link.
      Link format: https://app.domain.com/reset-password?token=xxx
    </note>
  </implementation-notes>

  <dependencies>
    <backend>
      <package name="FluentValidation" version="12.1.0">Request validation</package>
      <package name="MediatR" version="13.1.0">CQRS command/query handling</package>
      <package name="Microsoft.EntityFrameworkCore" version="10.0.0">Database access</package>
      <package name="Microsoft.AspNetCore.Identity.EntityFrameworkCore">User management, password reset tokens</package>
    </backend>
    <frontend>
      <package name="@angular/core" version="^20.3.0">Angular framework</package>
      <package name="@angular/forms" version="^20.3.0">Reactive forms</package>
      <package name="@angular/material" version="^20.2.14">UI components</package>
      <package name="@angular/router" version="^20.3.0">Routing for reset-password page</package>
    </frontend>
  </dependencies>

  <testing-context>
    <test-patterns>
      <pattern name="Integration Tests">
        See AuthControllerTests.cs for existing patterns using:
        - PropertyManagerWebApplicationFactory
        - FakeEmailService (singleton for capturing sent emails)
        - FluentAssertions
        - Creating/verifying users via helper methods
      </pattern>
      <pattern name="Unit Tests">
        Test handlers in isolation with mocked interfaces:
        - IIdentityService
        - IEmailService
        - IJwtService
      </pattern>
    </test-patterns>

    <test-cases>
      <category name="ForgotPassword Endpoint">
        <test>ForgotPassword_WithValidEmail_Returns204AndSendsEmail</test>
        <test>ForgotPassword_WithNonexistentEmail_Returns204_NoEmailSent (security)</test>
        <test>ForgotPassword_WithInvalidEmailFormat_Returns400</test>
        <test>ForgotPassword_WithEmptyEmail_Returns400</test>
      </category>
      <category name="ResetPassword Endpoint">
        <test>ResetPassword_WithValidToken_Returns204AndUpdatesPassword</test>
        <test>ResetPassword_WithExpiredToken_Returns400</test>
        <test>ResetPassword_WithInvalidToken_Returns400</test>
        <test>ResetPassword_WithAlreadyUsedToken_Returns400</test>
        <test>ResetPassword_WithWeakPassword_Returns400WithValidationErrors</test>
        <test>ResetPassword_InvalidatesAllExistingSessions (AC6.4)</test>
      </category>
      <category name="E2E Flow">
        <test>User can complete full password reset flow</test>
        <test>User cannot login with old password after reset</test>
        <test>User can login with new password after reset</test>
        <test>Other devices logged out after password reset</test>
      </category>
    </test-cases>

    <test-infrastructure>
      <file path="backend/tests/PropertyManager.Api.Tests/PropertyManagerWebApplicationFactory.cs">
        Custom WebApplicationFactory with in-memory DB and FakeEmailService
      </file>
      <file path="backend/tests/PropertyManager.Api.Tests/FakeEmailService.cs">
        Captures sent emails for verification in tests.
        Needs extension to capture password reset emails.
      </file>
    </test-infrastructure>
  </testing-context>

  <frontend-context>
    <components-to-create>
      <component name="ForgotPasswordComponent" path="frontend/src/app/features/auth/forgot-password/">
        <description>Form to request password reset email</description>
        <fields>
          <field name="email" type="email" required="true">User's email address</field>
        </fields>
        <behavior>
          - Submit calls AuthService.forgotPassword()
          - Always show success message (even if email doesn't exist)
          - Link back to login page
        </behavior>
      </component>
      <component name="ResetPasswordComponent" path="frontend/src/app/features/auth/reset-password/">
        <description>Form to enter new password</description>
        <fields>
          <field name="newPassword" type="password" required="true">New password</field>
          <field name="confirmPassword" type="password" required="true">Confirm password</field>
        </fields>
        <behavior>
          - Extract token from query params on init
          - Validate passwords match client-side
          - Submit calls AuthService.resetPassword()
          - On success, redirect to login with success message
          - On error (expired/invalid token), show error with link to request new reset
        </behavior>
      </component>
    </components-to-create>

    <routes-to-add>
      <route path="/forgot-password" component="ForgotPasswordComponent" guard="none">
        Public route for requesting password reset
      </route>
      <route path="/reset-password" component="ResetPasswordComponent" guard="none">
        Public route with ?token=xxx query parameter
      </route>
    </routes-to-add>

    <ui-patterns>
      <pattern name="Form Layout">Follow existing login/register form patterns with Angular Material</pattern>
      <pattern name="Error Display">Use mat-error for field validation, mat-snackbar for API errors</pattern>
      <pattern name="Password Strength">Show validation hints for password requirements</pattern>
    </ui-patterns>
  </frontend-context>

  <security-considerations>
    <consideration priority="critical">
      Token Timing: Reset token must expire after 1 hour (AC6.2). Use timestamp comparison,
      not just database storage.
    </consideration>
    <consideration priority="critical">
      Token Single-Use: Mark token as used after successful reset (AC6.5). Prevent replay attacks.
    </consideration>
    <consideration priority="critical">
      Email Enumeration Prevention: Always return 204 from forgot-password, regardless of
      whether the email exists in the system.
    </consideration>
    <consideration priority="high">
      Password Validation: Reuse existing password strength validation from RegisterCommandValidator.
    </consideration>
    <consideration priority="high">
      Session Invalidation: Use RevokeAllUserRefreshTokensAsync to invalidate all sessions (AC6.4).
    </consideration>
    <consideration priority="medium">
      Rate Limiting: Consider rate limiting forgot-password endpoint to prevent abuse.
      (Note: Deferred per tech spec - low risk for single user MVP)
    </consideration>
  </security-considerations>

  <definition-of-done>
    <checklist>
      <item>Backend: ForgotPassword command/handler implemented</item>
      <item>Backend: ResetPassword command/handler implemented</item>
      <item>Backend: IIdentityService extended with password reset methods</item>
      <item>Backend: IEmailService extended with SendPasswordResetEmailAsync</item>
      <item>Backend: AuthController endpoints added</item>
      <item>Backend: Integration tests for forgot-password endpoint</item>
      <item>Backend: Integration tests for reset-password endpoint</item>
      <item>Backend: Unit tests for command handlers</item>
      <item>Frontend: AuthService methods added</item>
      <item>Frontend: ForgotPasswordComponent implemented</item>
      <item>Frontend: ResetPasswordComponent implemented</item>
      <item>Frontend: Routes configured</item>
      <item>Frontend: Component tests written</item>
      <item>E2E: Full flow tested (request reset -> click link -> new password -> login)</item>
      <item>Security: Token expiration verified (1 hour)</item>
      <item>Security: Token single-use verified</item>
      <item>Security: Email enumeration prevention verified</item>
      <item>Security: All sessions invalidated after reset verified</item>
      <item>All tests passing</item>
      <item>Build succeeds with no warnings</item>
    </checklist>
  </definition-of-done>
</story-context>
