# Story 13.2: Frontend Photo Components

Status: ready-for-dev

GitHub Issue: #99 (Part 2 of 2)

Follows: PR #102 (Backend Photo Service)

## Story

As a user,
I want reusable photo viewing and upload components,
so that I have a consistent experience when working with photos across the application.

## Acceptance Criteria

1. `PhotoViewerComponent` created in shared components (adapted from ReceiptImageViewer)
2. PhotoViewerComponent supports `thumbnailUrl` input for list view optimization
3. PhotoViewerComponent retains all existing features (zoom, pan, rotate, PDF handling)
4. `PhotoUploadService` created with generic upload capability
5. `DragDropUploadComponent` created for desktop drag-and-drop uploads
6. DragDropUploadComponent validates file types and sizes
7. DragDropUploadComponent shows preview thumbnails before upload
8. DragDropUploadComponent is keyboard accessible with ARIA labels
9. Existing receipt components updated to use shared PhotoViewerComponent
10. All existing receipt frontend tests pass
11. Manual regression tests R1-R14 pass

## Tasks / Subtasks

- [ ] Task 0: Create PhotosController backend endpoints (Prerequisite for AC: #4)
  - [ ] 0.1 Create `Photos/` folder in `PropertyManager.Application/`
  - [ ] 0.2 Create `GeneratePhotoUploadUrlCommand.cs` with request/response records
  - [ ] 0.3 Create `GeneratePhotoUploadUrlHandler.cs` using `IPhotoService.GenerateUploadUrlAsync()`
  - [ ] 0.4 Create `GeneratePhotoUploadUrlValidator.cs` using FluentValidation
  - [ ] 0.5 Create `ConfirmPhotoUploadCommand.cs` with request/response records
  - [ ] 0.6 Create `ConfirmPhotoUploadHandler.cs` using `IPhotoService.ConfirmUploadAsync()`
  - [ ] 0.7 Create `PhotosController.cs` at `PropertyManager.Api/Controllers/`
  - [ ] 0.8 Add `POST /api/v1/photos/upload-url` endpoint
  - [ ] 0.9 Add `POST /api/v1/photos/confirm` endpoint
  - [ ] 0.10 Write unit tests for handlers and validators
  - [ ] 0.11 Run `npm run generate-api` in frontend to regenerate TypeScript client

- [ ] Task 1: Create PhotoViewerComponent (AC: #1, #2, #3)
  - [ ] 1.1 Create `shared/components/photo-viewer/` directory
  - [ ] 1.2 Create `photo-viewer.component.ts` - copy and adapt from ReceiptImageViewerComponent
  - [ ] 1.3 Add `thumbnailUrl` input for list view usage
  - [ ] 1.4 Add loading state for thumbnail -> full image transition
  - [ ] 1.5 Retain zoom controls (50%-200%, 0.25 increments)
  - [ ] 1.6 Retain rotate controls (90° left/right)
  - [ ] 1.7 Retain pan/drag when zoomed
  - [ ] 1.8 Retain PDF special handling (icon + "Open PDF" link)
  - [ ] 1.9 Retain error state with retry button
  - [ ] 1.10 Write unit tests for PhotoViewerComponent

- [ ] Task 2: Create PhotoUploadService (AC: #4)
  - [ ] 2.1 Create `shared/services/photo-upload.service.ts`
  - [ ] 2.2 Define `PhotoUploadOptions` interface (entityType, entityId, onProgress)
  - [ ] 2.3 Define `PhotoUploadResult` interface (storageKey, thumbnailStorageKey, viewUrl, thumbnailUrl)
  - [ ] 2.4 Implement `uploadPhoto(file, options)` - **NOTE: Requires API endpoints - see Dev Notes**
  - [ ] 2.5 Implement `isValidFileType(contentType)` helper
  - [ ] 2.6 Implement `isValidFileSize(bytes)` helper
  - [ ] 2.7 Write unit tests for PhotoUploadService

- [ ] Task 3: Create DragDropUploadComponent (AC: #5, #6, #7, #8)
  - [ ] 3.1 Create `shared/components/drag-drop-upload/` directory
  - [ ] 3.2 Create component files (ts, html, scss, spec.ts)
  - [ ] 3.3 Implement inputs: `accept`, `maxSizeBytes`, `multiple`, `disabled`
  - [ ] 3.4 Implement outputs: `filesSelected`, `uploadError`
  - [ ] 3.5 Implement drag-over visual feedback (dashed -> solid border, background highlight)
  - [ ] 3.6 Implement click-to-browse with hidden file input
  - [ ] 3.7 Implement file type validation with error snackbar
  - [ ] 3.8 Implement file size validation with error snackbar
  - [ ] 3.9 Implement preview thumbnails for selected images
  - [ ] 3.10 Implement remove button on each preview
  - [ ] 3.11 Display file count and total size
  - [ ] 3.12 Add keyboard navigation (Tab to button, Enter to open picker)
  - [ ] 3.13 Add ARIA labels for screen readers
  - [ ] 3.14 Write unit tests for validation logic and interactions

- [ ] Task 4: Update receipt components (AC: #9, #10)
  - [ ] 4.1 Update receipt feature imports to use PhotoViewerComponent
  - [ ] 4.2 Verify ReceiptImageViewerComponent can be deprecated (or create re-export alias)
  - [ ] 4.3 Run all receipt frontend tests (`npm test -- --filter receipt`)
  - [ ] 4.4 Fix any broken tests

- [ ] Task 5: Manual regression testing (AC: #11)
  - [ ] 5.1 R1: JPEG upload via mobile FAB - receipt appears in queue
  - [ ] 5.2 R2: PNG upload via mobile FAB - receipt appears in queue
  - [ ] 5.3 R3: PDF upload via mobile FAB - receipt appears with PDF icon
  - [ ] 5.4 R4: Large file (>10MB) rejected with error snackbar
  - [ ] 5.5 R5: Invalid file type rejected with error snackbar
  - [ ] 5.6 R7: View receipt image - full image loads with controls
  - [ ] 5.7 R8: Zoom in/out - image scales 0.5x to 2.0x
  - [ ] 5.8 R9: Pan when zoomed - image pans smoothly
  - [ ] 5.9 R10: Rotate image - rotates 90° increments
  - [ ] 5.10 R11: Reset view - returns to 100%, 0° rotation
  - [ ] 5.11 R12: View PDF receipt - PDF icon shown with "Open PDF" link
  - [ ] 5.12 R14: Process receipt to expense - receipt marked processed

## Dev Notes

### CRITICAL: Parallel Development Environment

**Another Claude instance is running on ports 5292 (API) and 4200 (frontend).**

You MUST use different ports:
- Frontend: `ng serve --port 4201`
- Backend: Configure to use port 5293 in `launchSettings.json` or via `ASPNETCORE_URLS`
- Update `proxy.conf.json` to point to your backend port

Both instances share the same PostgreSQL database via docker compose.

### CRITICAL: Receipts Backend is UNTOUCHED

**This story does NOT modify the receipts backend flow:**
- `ReceiptsController` - NO CHANGES
- Receipt commands/queries - NO CHANGES
- Receipt database tables - NO CHANGES
- `ReceiptCaptureService` (frontend) - NO CHANGES

**What this story DOES change for receipts (frontend only):**
- Swaps `ReceiptImageViewerComponent` → shared `PhotoViewerComponent` (same code, moved to shared)
- Regression tests R1-R14 verify nothing breaks

### Task 0: PhotosController Backend Details

**PR #102 created services but no HTTP endpoints.** Task 0 creates them.

**Existing services to use (DO NOT recreate):**
- `IPhotoService` at `backend/src/PropertyManager.Application/Common/Interfaces/IPhotoService.cs`
- `PhotoService` at `backend/src/PropertyManager.Infrastructure/Storage/PhotoService.cs`
- `IThumbnailService` for 300x300px thumbnails
- `PhotoValidation` with 10MB limit, allowed types: jpeg, png, gif, webp, bmp, tiff

**Create new CQRS commands (follow ReceiptsController pattern):**

```
PropertyManager.Application/Photos/
├── GeneratePhotoUploadUrl.cs      # Command, Handler, Request/Response records
├── GeneratePhotoUploadUrlValidator.cs
├── ConfirmPhotoUpload.cs          # Command, Handler, Request/Response records
└── ConfirmPhotoUploadValidator.cs
```

**PhotosController endpoints:**
```csharp
[Route("api/v1/photos")]
public class PhotosController : ControllerBase
{
    // POST /api/v1/photos/upload-url
    // Request: { entityType, entityId, contentType, fileSizeBytes, originalFileName }
    // Response: { uploadUrl, storageKey, thumbnailStorageKey, expiresAt }

    // POST /api/v1/photos/confirm
    // Request: { storageKey, thumbnailStorageKey, contentType, fileSizeBytes }
    // Response: { storageKey, thumbnailStorageKey, contentType, fileSizeBytes }
}
```

**Reference:** `ReceiptsController.cs` at `backend/src/PropertyManager.Api/Controllers/ReceiptsController.cs` (313 lines)

### Frontend PhotoUploadService Pattern

After Task 0, the frontend service follows this flow (same as receipts):
```typescript
// Step 1: Request presigned URL
const uploadUrlResponse = await firstValueFrom(
  this.apiClient.photos_GenerateUploadUrl({...})
);
// Step 2: Upload directly to S3
await fetch(uploadUrlResponse.uploadUrl!, { method: 'PUT', body: file });
// Step 3: Confirm upload (triggers thumbnail generation)
await firstValueFrom(this.apiClient.photos_Confirm({...}));
```

### Component Architecture

All new components are **standalone** Angular components using:
- Angular 20+ signals for state management
- OnPush change detection
- Inline templates/styles OR separate files (follow existing patterns in `shared/components/`)

### PhotoViewerComponent Specification

**Location:** `frontend/src/app/shared/components/photo-viewer/`

**Inputs:**
```typescript
viewUrl = input.required<string>();      // Presigned URL for full-size image
thumbnailUrl = input<string>();          // Optional presigned URL for thumbnail (NEW)
contentType = input.required<string>();  // MIME type for PDF detection
```

**Features to preserve from ReceiptImageViewerComponent:**
- Zoom: 50%-200% (signal: `scale`, increments: 0.25)
- Rotate: 0°, 90°, 180°, 270° (signal: `rotation`)
- Pan: translateX/Y when zoomed > 1 (signals: `translateX`, `translateY`)
- Computed: `imageTransform`, `isPdf`
- States: `isLoading`, `hasError`, `isDragging`

**Source reference:** `frontend/src/app/features/receipts/components/receipt-image-viewer/receipt-image-viewer.component.ts` (364 lines, fully functional)

### DragDropUploadComponent Specification

**Location:** `frontend/src/app/shared/components/drag-drop-upload/`

**Inputs:**
```typescript
@Input() accept = 'image/jpeg,image/png';
@Input() maxSizeBytes = 10485760; // 10MB (matches PhotoValidation.MaxFileSizeBytes)
@Input() multiple = true;
@Input() disabled = false;
```

**Outputs:**
```typescript
@Output() filesSelected = new EventEmitter<File[]>();
@Output() uploadError = new EventEmitter<string>();
```

**Signals:**
```typescript
isDragging = signal(false);
selectedFiles = signal<File[]>([]);
```

### Styling (Angular Material Theme)

Use CSS variables from the Angular Material theme (per Epic 8.5):
```scss
.drag-drop-zone {
  border: 2px dashed var(--mat-sys-outline);
  border-radius: 8px;
  padding: 32px;
  text-align: center;
  transition: all 0.2s ease;
  cursor: pointer;

  &.dragging {
    border-color: var(--mat-sys-primary);
    border-style: solid;
    background-color: var(--mat-sys-primary-container);
  }

  &:hover:not(.disabled) {
    border-color: var(--mat-sys-primary);
    background-color: var(--mat-sys-surface-variant);
  }

  &.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
}
```

### File Locations Summary

**Backend - Create (Task 0):**
- `backend/src/PropertyManager.Application/Photos/GeneratePhotoUploadUrl.cs`
- `backend/src/PropertyManager.Application/Photos/GeneratePhotoUploadUrlValidator.cs`
- `backend/src/PropertyManager.Application/Photos/ConfirmPhotoUpload.cs`
- `backend/src/PropertyManager.Application/Photos/ConfirmPhotoUploadValidator.cs`
- `backend/src/PropertyManager.Api/Controllers/PhotosController.cs`
- `backend/tests/PropertyManager.Application.Tests/Photos/GeneratePhotoUploadUrlTests.cs`
- `backend/tests/PropertyManager.Application.Tests/Photos/ConfirmPhotoUploadTests.cs`

**Frontend - Create:**
- `frontend/src/app/shared/components/photo-viewer/photo-viewer.component.ts`
- `frontend/src/app/shared/components/photo-viewer/photo-viewer.component.spec.ts`
- `frontend/src/app/shared/components/drag-drop-upload/drag-drop-upload.component.ts`
- `frontend/src/app/shared/components/drag-drop-upload/drag-drop-upload.component.html`
- `frontend/src/app/shared/components/drag-drop-upload/drag-drop-upload.component.scss`
- `frontend/src/app/shared/components/drag-drop-upload/drag-drop-upload.component.spec.ts`
- `frontend/src/app/shared/services/photo-upload.service.ts`
- `frontend/src/app/shared/services/photo-upload.service.spec.ts`

**Frontend - Modify:**
- `frontend/src/app/features/receipts/` - Update imports to use shared PhotoViewerComponent

**Backend - NO CHANGES (receipts untouched):**
- `backend/src/PropertyManager.Api/Controllers/ReceiptsController.cs` - DO NOT MODIFY
- `backend/src/PropertyManager.Application/Receipts/` - DO NOT MODIFY

### Existing Shared Components Pattern

Reference these for patterns:
- `shared/components/confirm-dialog/` - Dialog with cancel/confirm
- `shared/components/stats-bar/` - Stats display
- `shared/components/empty-state/` - Empty state handling
- `shared/components/loading-spinner/` - Loading states

### Testing Standards

- **Framework:** Vitest with Angular testing utilities
- **Component tests:** Use `TestBed`
- **Mock services:** `vi.mock()` or `jasmine.createSpyObj()`
- **Drag events:** Test with synthetic `DragEvent` objects
- **Run tests:** `npm test` from `/frontend`

### Backend PhotoService Reference

From `IPhotoService.cs`:
```csharp
// Entity types
enum PhotoEntityType { Receipts, Properties, Vendors, Users }

// Validation
MaxFileSizeBytes = 10 * 1024 * 1024; // 10MB
AllowedContentTypes = { "image/jpeg", "image/png", "image/gif", "image/webp", "image/bmp", "image/tiff" }

// Storage key pattern
"{accountId}/{entityType}/{year}/{guid}.{ext}"
// Thumbnail pattern
"{accountId}/{entityType}/{year}/{guid}_thumb.jpg"
```

### Project Structure Notes

- Frontend follows feature-based architecture: `features/`, `shared/`, `core/`
- Shared components are standalone and reusable across features
- State management: @ngrx/signals (NOT NgRx store)
- API client: Auto-generated via NSwag from backend

### References

- [Source: frontend/src/app/features/receipts/components/receipt-image-viewer/receipt-image-viewer.component.ts]
- [Source: frontend/src/app/features/receipts/services/receipt-capture.service.ts]
- [Source: backend/src/PropertyManager.Application/Common/Interfaces/IPhotoService.cs]
- [Source: _bmad-output/implementation-artifacts/github-issue-1-generic-photo-service.md]
- [Source: GitHub Issue #99]
- [Source: GitHub PR #102]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

